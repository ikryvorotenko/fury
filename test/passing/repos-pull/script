mkdir -p repo1
(
    cd repo1
    mkdir src
    git init -q
    touch src/version1 && git add -A && git commit -q -m"."
    
)

mkdir -p fury_project
(
    cd fury_project
    fury layer init
    git init -q
    git add layer.fury
    git commit -q -m "Initial commit"
    fury project add -n webpage
    fury module add -n hello-world
    fury repo add -u https://github.com/propensive/base.git -n base
    fury import add -i base:2.12.6
    fury module update -c scala/compiler
    fury repo add -u $(realpath ../repo1) -n repo1 --version master
    fury source add -d repo1:src
)

(
    cd repo1
    touch src/version2 && git add -A && git commit -q -m"."
)

(
    cd fury_project
    fury repo pull --all > /dev/null
    fury build compile --output linear
    git commit -q -am"."
)

(
    cd repo1
    touch src/version3 && git add -A && git commit -q -m"."
)

git clone fury_project fury_project_clone 2> /dev/null

(
    cd fury_project_clone
    fury build compile --output linear
    ! find ~/.furyrc/sources -name version1 -exec false \;
    ! find ~/.furyrc/sources -name version2 -exec false \;
    find ~/.furyrc/sources -name version2 -exec false \;
)
